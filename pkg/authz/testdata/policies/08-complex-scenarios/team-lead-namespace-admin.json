{
  "id": "complex-002",
  "name": "Team lead with namespace-level admin delegation",
  "description": "Policy that allows team leads to manage access entries for their team's namespace, but not cluster-wide access or admin policies.",
  "source": "https://docs.openshift.com/rosa/rosa_architecture/rosa-sts-about-iam-resources.html",
  "policy": {
    "version": "v0",
    "statements": [
      {
        "sid": "AllowReadOperations",
        "effect": "Allow",
        "actions": [
          "rosa:DescribeCluster",
          "rosa:DescribeAccessEntry",
          "rosa:ListClusters",
          "rosa:ListAccessEntries",
          "rosa:ListAccessPolicies",
          "rosa:ListAssociatedAccessPolicies"
        ],
        "resources": [
          "*"
        ]
      },
      {
        "sid": "AllowManageTeamAccessEntries",
        "effect": "Allow",
        "conditions": {
          "StringEquals": {
            "rosa:ResourceTag/Team": "${aws:PrincipalTag/Team}"
          }
        },
        "actions": [
          "rosa:CreateAccessEntry",
          "rosa:DeleteAccessEntry",
          "rosa:UpdateAccessEntry"
        ],
        "resources": [
          "*"
        ]
      },
      {
        "sid": "AllowAssociateNamespaceScopedPolicies",
        "effect": "Allow",
        "conditions": {
          "StringEquals": {
            "rosa:accessScope": "namespace"
          },
          "ForAllValues:StringLike": {
            "rosa:namespaces": [
              "team-${aws:PrincipalTag/Team}",
              "team-${aws:PrincipalTag/Team}-*"
            ]
          }
        },
        "actions": [
          "rosa:AssociateAccessPolicy",
          "rosa:DisassociateAccessPolicy"
        ],
        "resources": [
          "*"
        ]
      },
      {
        "sid": "DenyClusterScopedPolicies",
        "effect": "Deny",
        "conditions": {
          "StringEquals": {
            "rosa:accessScope": "cluster"
          }
        },
        "actions": [
          "rosa:AssociateAccessPolicy"
        ],
        "resources": [
          "*"
        ]
      },
      {
        "sid": "DenyAdminPolicies",
        "effect": "Deny",
        "conditions": {
          "ArnLike": {
            "rosa:policyArn": [
              "arn:aws:rosa::aws:cluster-access-policy/ROSAClusterAdminPolicy",
              "arn:aws:rosa::aws:cluster-access-policy/ROSAAdminPolicy"
            ]
          }
        },
        "actions": [
          "rosa:AssociateAccessPolicy"
        ],
        "resources": [
          "*"
        ]
      },
      {
        "sid": "DenyModifyOtherTeamEntries",
        "effect": "Deny",
        "conditions": {
          "StringNotEquals": {
            "rosa:ResourceTag/Team": "${aws:PrincipalTag/Team}"
          }
        },
        "actions": [
          "rosa:DeleteAccessEntry",
          "rosa:UpdateAccessEntry"
        ],
        "resources": [
          "*"
        ]
      }
    ]
  },
  "testCases": [
    {
      "description": "Team alpha lead can create access entry for their team",
      "principal": {
        "tags": {
          "Team": "alpha"
        }
      },
      "request": {
        "action": "rosa:CreateAccessEntry",
        "resource": "arn:aws:rosa:us-west-2:111122223333:cluster/shared-cluster",
        "resourceTags": {
          "Team": "alpha"
        }
      },
      "expectedResult": "ALLOW"
    },
    {
      "description": "Team alpha lead can grant view access to team-alpha namespace",
      "principal": {
        "tags": {
          "Team": "alpha"
        }
      },
      "request": {
        "action": "rosa:AssociateAccessPolicy",
        "resource": "arn:aws:rosa:us-west-2:111122223333:access-entry/shared-cluster/role/alpha-dev",
        "context": {
          "rosa:accessScope": "namespace",
          "rosa:namespaces": [
            "team-alpha"
          ],
          "rosa:policyArn": "arn:aws:rosa::aws:cluster-access-policy/ROSAViewPolicy"
        }
      },
      "expectedResult": "ALLOW"
    },
    {
      "description": "Team alpha lead cannot grant access to team-beta namespace",
      "principal": {
        "tags": {
          "Team": "alpha"
        }
      },
      "request": {
        "action": "rosa:AssociateAccessPolicy",
        "resource": "arn:aws:rosa:us-west-2:111122223333:access-entry/shared-cluster/role/alpha-dev",
        "context": {
          "rosa:accessScope": "namespace",
          "rosa:namespaces": [
            "team-beta"
          ],
          "rosa:policyArn": "arn:aws:rosa::aws:cluster-access-policy/ROSAViewPolicy"
        }
      },
      "expectedResult": "DENY"
    },
    {
      "description": "Team alpha lead cannot grant cluster-wide access",
      "principal": {
        "tags": {
          "Team": "alpha"
        }
      },
      "request": {
        "action": "rosa:AssociateAccessPolicy",
        "resource": "arn:aws:rosa:us-west-2:111122223333:access-entry/shared-cluster/role/alpha-dev",
        "context": {
          "rosa:accessScope": "cluster",
          "rosa:policyArn": "arn:aws:rosa::aws:cluster-access-policy/ROSAViewPolicy"
        }
      },
      "expectedResult": "DENY"
    },
    {
      "description": "Team alpha lead cannot grant admin policy even to own namespace",
      "principal": {
        "tags": {
          "Team": "alpha"
        }
      },
      "request": {
        "action": "rosa:AssociateAccessPolicy",
        "resource": "arn:aws:rosa:us-west-2:111122223333:access-entry/shared-cluster/role/alpha-dev",
        "context": {
          "rosa:accessScope": "namespace",
          "rosa:namespaces": [
            "team-alpha"
          ],
          "rosa:policyArn": "arn:aws:rosa::aws:cluster-access-policy/ROSAAdminPolicy"
        }
      },
      "expectedResult": "DENY"
    },
    {
      "description": "Team alpha lead cannot delete team beta's access entry",
      "principal": {
        "tags": {
          "Team": "alpha"
        }
      },
      "request": {
        "action": "rosa:DeleteAccessEntry",
        "resource": "arn:aws:rosa:us-west-2:111122223333:access-entry/shared-cluster/role/beta-dev",
        "resourceTags": {
          "Team": "beta"
        }
      },
      "expectedResult": "DENY"
    }
  ],
  "notes": "This enables self-service access management at the team level while maintaining cluster-wide security. Team leads can onboard new team members without involving cluster admins."
}
