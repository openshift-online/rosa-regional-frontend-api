{
  "id": "complex-004",
  "name": "CI/CD pipeline role for ROSA deployments",
  "description": "Policy for a CI/CD pipeline role that can deploy to ROSA clusters, manage node pools, but cannot create/delete clusters or modify access controls.",
  "source": "https://docs.openshift.com/rosa/rosa_architecture/rosa-sts-about-iam-resources.html",
  "policy": {
    "version": "v0",
    "statements": [
      {
        "sid": "AllowClusterDiscovery",
        "effect": "Allow",
        "actions": [
          "rosa:DescribeCluster",
          "rosa:ListClusters"
        ],
        "resources": [
          "*"
        ]
      },
      {
        "sid": "AllowNodePoolManagement",
        "effect": "Allow",
        "actions": [
          "rosa:DescribeNodePool",
          "rosa:ListNodePools",
          "rosa:UpdateNodePoolVersion",
          "rosa:UpdateNodePoolConfig"
        ],
        "resources": [
          "arn:aws:rosa:*:111122223333:cluster/*",
          "arn:aws:rosa:*:111122223333:nodepool/*/*/*"
        ]
      },
      {
        "sid": "AllowVersionUpdates",
        "effect": "Allow",
        "actions": [
          "rosa:UpdateClusterVersion",
          "rosa:DescribeUpdate",
          "rosa:ListUpdates"
        ],
        "resources": [
          "arn:aws:rosa:*:111122223333:cluster/*"
        ]
      },
      {
        "sid": "DenyClusterLifecycle",
        "effect": "Deny",
        "actions": [
          "rosa:CreateCluster",
          "rosa:DeleteCluster"
        ],
        "resources": [
          "*"
        ]
      },
      {
        "sid": "DenyAccessManagement",
        "effect": "Deny",
        "actions": [
          "rosa:CreateAccessEntry",
          "rosa:DeleteAccessEntry",
          "rosa:UpdateAccessEntry",
          "rosa:AssociateAccessPolicy",
          "rosa:DisassociateAccessPolicy"
        ],
        "resources": [
          "*"
        ]
      },
      {
        "sid": "DenyNodePoolCreationDeletion",
        "effect": "Deny",
        "actions": [
          "rosa:CreateNodePool",
          "rosa:DeleteNodePool"
        ],
        "resources": [
          "*"
        ]
      },
      {
        "sid": "AllowTagReading",
        "effect": "Allow",
        "actions": [
          "rosa:ListTagsForResource"
        ],
        "resources": [
          "*"
        ]
      }
    ]
  },
  "testCases": [
    {
      "description": "Pipeline can describe clusters for deployment",
      "request": {
        "action": "rosa:DescribeCluster",
        "resource": "arn:aws:rosa:us-west-2:111122223333:cluster/prod-cluster"
      },
      "expectedResult": "ALLOW"
    },
    {
      "description": "Pipeline can update cluster version",
      "request": {
        "action": "rosa:UpdateClusterVersion",
        "resource": "arn:aws:rosa:us-west-2:111122223333:cluster/prod-cluster"
      },
      "expectedResult": "ALLOW"
    },
    {
      "description": "Pipeline can update node pool config",
      "request": {
        "action": "rosa:UpdateNodePoolConfig",
        "resource": "arn:aws:rosa:us-west-2:111122223333:nodepool/prod-cluster/workers/abc123"
      },
      "expectedResult": "ALLOW"
    },
    {
      "description": "Pipeline cannot create new clusters",
      "request": {
        "action": "rosa:CreateCluster",
        "resource": "*"
      },
      "expectedResult": "DENY"
    },
    {
      "description": "Pipeline cannot delete clusters",
      "request": {
        "action": "rosa:DeleteCluster",
        "resource": "arn:aws:rosa:us-west-2:111122223333:cluster/prod-cluster"
      },
      "expectedResult": "DENY"
    },
    {
      "description": "Pipeline cannot create access entries",
      "request": {
        "action": "rosa:CreateAccessEntry",
        "resource": "arn:aws:rosa:us-west-2:111122223333:cluster/prod-cluster"
      },
      "expectedResult": "DENY"
    },
    {
      "description": "Pipeline cannot create node pools",
      "request": {
        "action": "rosa:CreateNodePool",
        "resource": "arn:aws:rosa:us-west-2:111122223333:cluster/prod-cluster"
      },
      "expectedResult": "DENY"
    }
  ],
  "notes": "This policy is designed for automation. The pipeline can deploy applications and update existing infrastructure but cannot make structural changes. Cluster lifecycle and access management remain with human operators."
}
