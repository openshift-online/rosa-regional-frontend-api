{
  "id": "abac-001",
  "name": "Manage only clusters with matching owner tag",
  "description": "Policy that allows users to manage only clusters they created (tagged with their username as owner). Classic ABAC pattern.",
  "source": "https://docs.openshift.com/rosa/rosa_architecture/rosa-sts-about-iam-resources.html",
  "policy": {
    "version": "v0",
    "statements": [
      {
        "sid": "AllowCreateWithOwnerTag",
        "effect": "Allow",
        "conditions": {
          "StringEquals": {
            "rosa:RequestTag/Owner": "${aws:username}"
          },
          "ForAllValues:StringEquals": {
            "rosa:TagKeys": [
              "Owner",
              "Environment",
              "Project"
            ]
          }
        },
        "actions": [
          "rosa:CreateCluster"
        ],
        "resources": [
          "*"
        ]
      },
      {
        "sid": "AllowManageOwnClusters",
        "effect": "Allow",
        "conditions": {
          "StringEquals": {
            "rosa:ResourceTag/Owner": "${aws:username}"
          }
        },
        "actions": [
          "rosa:DeleteCluster",
          "rosa:UpdateClusterConfig",
          "rosa:UpdateClusterVersion",
          "rosa:DescribeCluster",
          "rosa:CreateNodePool",
          "rosa:DeleteNodePool",
          "rosa:UpdateNodePoolConfig"
        ],
        "resources": [
          "*"
        ]
      },
      {
        "sid": "AllowListAndDescribeAll",
        "effect": "Allow",
        "actions": [
          "rosa:ListClusters",
          "rosa:ListNodePools",
          "rosa:DescribeNodePool",
          "rosa:ListTagsForResource"
        ],
        "resources": [
          "*"
        ]
      }
    ]
  },
  "testCases": [
    {
      "description": "User alice can create cluster with her owner tag",
      "principal": {
        "username": "alice"
      },
      "request": {
        "action": "rosa:CreateCluster",
        "resource": "arn:aws:rosa:us-west-2:111122223333:cluster/alice-cluster",
        "context": {
          "rosa:RequestTag/Owner": "alice",
          "rosa:TagKeys": [
            "Owner",
            "Environment"
          ]
        }
      },
      "expectedResult": "ALLOW"
    },
    {
      "description": "User alice cannot create cluster with bob's owner tag",
      "principal": {
        "username": "alice"
      },
      "request": {
        "action": "rosa:CreateCluster",
        "resource": "arn:aws:rosa:us-west-2:111122223333:cluster/fake-cluster",
        "context": {
          "rosa:RequestTag/Owner": "bob",
          "rosa:TagKeys": [
            "Owner"
          ]
        }
      },
      "expectedResult": "DENY"
    },
    {
      "description": "User alice can delete her own cluster",
      "principal": {
        "username": "alice"
      },
      "request": {
        "action": "rosa:DeleteCluster",
        "resource": "arn:aws:rosa:us-west-2:111122223333:cluster/alice-cluster",
        "resourceTags": {
          "Owner": "alice"
        }
      },
      "expectedResult": "ALLOW"
    },
    {
      "description": "User alice cannot delete bob's cluster",
      "principal": {
        "username": "alice"
      },
      "request": {
        "action": "rosa:DeleteCluster",
        "resource": "arn:aws:rosa:us-west-2:111122223333:cluster/bob-cluster",
        "resourceTags": {
          "Owner": "bob"
        }
      },
      "expectedResult": "DENY"
    },
    {
      "description": "User alice can list all clusters (for discovery)",
      "principal": {
        "username": "alice"
      },
      "request": {
        "action": "rosa:ListClusters",
        "resource": "*"
      },
      "expectedResult": "ALLOW"
    }
  ],
  "notes": "This implements the creator-owns-resource pattern. Users must tag clusters with their username as Owner during creation and can only manage clusters they own."
}
